'use strict';

const express = require('express');
const line = require('@line/bot-sdk');
const firebase = require('firebase-admin');
const { Client } = require("@googlemaps/google-maps-services-js");

require('dotenv').config();

// ----- LINE -----
const config = {
    channelAccessToken: process.env.CHANNEL_ACCESS_TOKEN,
    channelSecret: process.env.CHANNEL_SECRET,
};
const client = new line.Client(config);

// ----- Firebase -----
const serviceAccount = require('./serviceAccountKey.json');
if (firebase.apps.length === 0) {
    firebase.initializeApp({
        credential: firebase.credential.cert(serviceAccount)
    });
}
const db = firebase.firestore();

// ----- Google Maps -----
const googleMapsClient = new Client({});

// ----- Express App -----
const app = express();

const MRT_BLUE_LINE_STATIONS = {
        "‡∏´‡∏±‡∏ß‡∏•‡∏≥‡πÇ‡∏û‡∏á": {"lat": 13.739186, "lng": 100.516893},
    "‡∏™‡∏≤‡∏°‡∏¢‡πà‡∏≤‡∏ô": {"lat": 13.732952, "lng": 100.529431},
    "‡∏™‡∏µ‡∏•‡∏°": {"lat": 13.729908, "lng": 100.535898},
    "‡∏•‡∏∏‡∏°‡∏û‡∏¥‡∏ô‡∏µ": {"lat": 13.729172, "lng": 100.546305},
    "‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢": {"lat": 13.723912, "lng": 100.556276},
    "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥‡∏™‡∏¥‡∏£‡∏¥‡∏Å‡∏¥‡∏ï‡∏¥‡πå": {"lat": 13.722881, "lng": 100.561587},
    "‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó": {"lat": 13.738012, "lng": 100.561081},
    "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ": {"lat": 13.750873, "lng": 100.561919},
    "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 9": {"lat": 13.758031, "lng": 100.565439},
    "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢": {"lat": 13.765664, "lng": 100.569106},
    "‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á": {"lat": 13.778844, "lng": 100.574633},
    "‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏™‡∏≤‡∏£": {"lat": 13.789233, "lng": 100.574784},
    "‡∏£‡∏±‡∏ä‡∏î‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å": {"lat": 13.797274, "lng": 100.575647},
    "‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß": {"lat": 13.806659, "lng": 100.576899},
    "‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô": {"lat": 13.815779, "lng": 100.562144},
    "‡∏™‡∏ß‡∏ô‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£": {"lat": 13.822295, "lng": 100.552278},
    "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£": {"lat": 13.824706, "lng": 100.548481},
    "‡∏ö‡∏≤‡∏á‡∏ã‡∏∑‡πà‡∏≠": {"lat": 13.803362, "lng": 100.535032},
    "‡πÄ‡∏ï‡∏≤‡∏õ‡∏π‡∏ô": {"lat": 13.806306, "lng": 100.529450}, 
    "‡∏ö‡∏≤‡∏á‡πÇ‡∏û": {"lat": 13.811808, "lng": 100.521833},
    "‡∏ö‡∏≤‡∏á‡∏≠‡πâ‡∏≠": {"lat": 13.805565, "lng": 100.512686},
    "‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î": {"lat": 13.790588, "lng": 100.506541},
    "‡∏™‡∏¥‡∏£‡∏¥‡∏ô‡∏ò‡∏£": {"lat": 13.782017, "lng": 100.493922},
    "‡∏ö‡∏≤‡∏á‡∏¢‡∏µ‡πà‡∏Ç‡∏±‡∏ô": {"lat": 13.771146, "lng": 100.488390},
    "‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡∏ô‡∏ô‡∏ó‡πå": {"lat": 13.764491, "lng": 100.477085},
    "‡πÑ‡∏ü‡∏â‡∏≤‡∏¢": {"lat": 13.757352, "lng": 100.469033},
    "‡∏à‡∏£‡∏±‡∏ç‡∏Ø 13": {"lat": 13.751325, "lng": 100.470724},
    "‡∏ó‡πà‡∏≤‡∏û‡∏£‡∏∞": {"lat": 13.743015, "lng": 100.472280},
    "‡∏ö‡∏≤‡∏á‡πÑ‡∏ú‡πà": {"lat": 13.734685, "lng": 100.468841},
    "‡∏ö‡∏≤‡∏á‡∏´‡∏ß‡πâ‡∏≤": {"lat": 13.723824, "lng": 100.460144}, 
    "‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏©‡∏° 48": {"lat": 13.722686, "lng": 100.444747},
    "‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏à‡∏£‡∏¥‡∏ç": {"lat": 13.719601, "lng": 100.434440},
    "‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ": {"lat": 13.715367, "lng": 100.418041},
    "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≠‡∏á": {"lat": 13.710784, "lng": 100.406103},
    "‡∏ß‡∏±‡∏î‡∏°‡∏±‡∏á‡∏Å‡∏£": {"lat": 13.743734, "lng": 100.509747},
    "‡∏™‡∏≤‡∏°‡∏¢‡∏≠‡∏î": {"lat": 13.747199, "lng": 100.503276},
    "‡∏™‡∏ô‡∏≤‡∏°‡πÑ‡∏ä‡∏¢": {"lat": 13.743384, "lng": 100.495048},
    "‡∏≠‡∏¥‡∏™‡∏£‡∏†‡∏≤‡∏û": {"lat": 13.747444, "lng": 100.485233},
};

async function searchGooglePlaces(apiKey, keyword, lat, lng) {
    console.log(`Searching Google for: ${keyword}`);
    try {
        const response = await googleMapsClient.placesNearby({
            params: {
                location: { lat, lng },
                radius: 1500,
                keyword: keyword,
                language: 'th',
                key: apiKey,
            },
            timeout: 5000,
        });
        
        console.log('Successfully got response from Google API.');
        const sortedResults = response.data.results.sort((a, b) => (b.rating || 0) - (a.rating || 0));
        return sortedResults.slice(0, 5);

    } catch (e) {
        console.error("Google Maps API Error:", e.response ? e.response.data : e.message);
        return [];
    }
}

function createShopCarousel(places, apiKey) {
    if (!places || places.length === 0) {
        return { type: 'text', text: '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì' };
    }

    const bubbles = places.map(place => {
        const placeId = place.place_id;
        const name = place.name;
        const address = place.vicinity || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà';
        const rating = place.rating ? `‚≠ê ${place.rating.toFixed(1)}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';
        let imageUrl = "https://www. ‡ÆÆ‡Øá‡Æ≤‡Øç-level-seo.com/wp-content/uploads/2019/08/no-image-found.png";
        
        if (place.photos && place.photos.length > 0) {
            const photoReference = place.photos[0].photo_reference;
            imageUrl = `https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference=${photoReference}&key=${apiKey}`;
        }
        
        const gmapsUrl = `https://www.google.com/maps/search/?api=1&query=Google&query_place_id=${placeId}`;

        return {
            type: 'bubble',
            hero: { type: 'image', url: imageUrl, size: 'full', aspectRatio: '20:13', aspectMode: 'cover' },
            body: {
                type: 'box', layout: 'vertical',
                contents: [
                    { type: 'text', text: name, weight: 'bold', size: 'xl', wrap: true },
                    {
                        type: 'box', layout: 'baseline', margin: 'md',
                        contents: [ { type: 'text', text: rating, size: 'sm', color: '#999999', flex: 0 } ]
                    },
                    { type: 'text', text: address, wrap: true, size: 'sm', color: '#666666', margin: 'md' }
                ]
            },
            footer: {
                type: 'box', layout: 'vertical', spacing: 'sm',
                contents: [
                    { type: 'button', style: 'link', height: 'sm', action: { type: 'uri', label: '‡∏î‡∏π‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', uri: gmapsUrl } },
                    { type: 'button', style: 'primary', color: '#FF6B6B', height: 'sm', action: { type: 'postback', label: '‚ù§Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡∏î', data: `action=add_favorite&shop_id=${placeId}` } },
                    { type: 'button', style: 'secondary', color: '#BDBDBD', height: 'sm', action: { type: 'postback', label: 'üîñ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡∏î‡∏π‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á', data: `action=add_watch_later&shop_id=${placeId}` } },
                ]
            }
        };
    });

    return {
        type: 'flex',
        altText: '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
        contents: { type: 'carousel', contents: bubbles }
    };
};

app.post('/callback', line.middleware(config), (req, res) => {
    Promise
        .all(req.body.events.map(handleEvent))
        .then((result) => res.json(result))
        .catch((err) => {
            console.error(err);
            res.status(500).end();
        });
});

const handleEvent = async (event) => {
    // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Postback Event (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°) ---
    if (event.type === 'postback') {
        const data = event.postback.data;
        const params = new URLSearchParams(data);
        const action = params.get('action');
        const shopId = params.get('shop_id');
        const userId = event.source.userId;

        if (action === 'add_favorite') {
            const favoriteRef = db.collection('users').doc(userId).collection('favorites').doc(shopId);
            await favoriteRef.set({ addedAt: new Date() });
            
            // (‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)

            return client.replyMessage(event.replyToken, { type: 'text', text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‚ù§Ô∏è' });
        } 
        else if (action === 'add_watch_later') {
            const watchLaterRef = db.collection('users').doc(userId).collection('watch_later').doc(shopId);
            await watchLaterRef.set({ addedAt: new Date() });
            return client.replyMessage(event.replyToken, { type: 'text', text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏î‡∏π‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö üîñ' });
        }
    }

    // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Message Event (‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°) ---
    if (event.type !== 'message' || event.message.type !== 'text') {
        return Promise.resolve(null);
    }

    const textFromUser = event.message.text.trim();
    let foundStation = null;
    let keyword = textFromUser;

    for (const stationName in MRT_BLUE_LINE_STATIONS) {
        if (textFromUser.includes(stationName)) {
            foundStation = stationName;
            keyword = keyword.replace(stationName, '').trim();
            break;
        }
    }

    if (foundStation) {
        const stationInfo = MRT_BLUE_LINE_STATIONS[foundStation];
        
        const places = await searchGooglePlaces(process.env.GOOGLE_API_KEY, keyword, stationInfo.lat, stationInfo.lng);

        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô Caching ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà! ---
        if (places && places.length > 0) {
            const batch = db.batch();
            places.forEach(place => {
                const shopRef = db.collection('shops').doc(place.place_id);
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ LIFF
                batch.set(shopRef, {
                    name: place.name,
                    address: place.vicinity || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà',
                    // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                }, { merge: true });
            });
            await batch.commit();
            console.log(`Cached/Updated ${places.length} shops to Firestore.`);
        }
        // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô Caching ---

        const replyMessageObject = createShopCarousel(places, process.env.GOOGLE_API_KEY);
        return client.replyMessage(event.replyToken, replyMessageObject);

    } else {
        return client.replyMessage(event.replyToken, {
            type: 'text',
            text: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ MRT ‡∏™‡∏≤‡∏¢‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πà‡∏ô '‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà ‡∏™‡∏ô‡∏≤‡∏°‡πÑ‡∏ä‡∏¢' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô ‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó' ‡∏Ñ‡∏£‡∏±‡∏ö"
        });
    }
};

const port = process.env.PORT || 3000;
app.listen(port, () => {
    console.log(`listening on ${port}`);
});