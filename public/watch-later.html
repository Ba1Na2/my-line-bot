<!DOCTYPE html>
<html lang="th">
<head>
    <title>‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ - MRT Bot</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* CSS Variables for Theming */
        :root {
            --color-primary: #0D6EFD;
            --color-primary-dark: #00529B;
            --color-secondary: #6C757D;
            --color-background: #F8F9FA;
            --color-surface: #FFFFFF;
            --color-text-primary: #212529;
            --color-text-secondary: #6C757D;
            --color-border: #DEE2E6;
            --font-family-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body { 
            font-family: var(--font-family-sans-serif);
            margin: 0;
            background-color: var(--color-background);
            color: var(--color-text-primary);
        }
        .header {
            background-color: var(--color-surface);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        h1 {
            color: var(--color-primary-dark);
            font-size: 1.25em;
            padding: 16px 20px;
            margin: 0;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--color-border);
            padding: 0 10px;
        }
        .tab-button {
            flex: 1;
            padding: 12px 10px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1em;
            font-weight: 600;
            color: var(--color-text-secondary);
            border-bottom: 3px solid transparent;
            text-align: center;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-button.active {
            color: var(--color-primary); 
            border-bottom-color: var(--color-primary);
        }
        .content-area {
            padding: 20px;
        }
        .shop-list {
            display: none; 
        }
        .shop-list.active {
            display: grid;
            gap: 16px;
        }
        .shop-card { 
            background-color: var(--color-surface);
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .shop-card:hover {
            transform: translateY(-2px);
        }
        .shop-card img { 
            width: 120px; 
            height: 120px; 
            object-fit: cover;
            flex-shrink: 0;
            border-right: 1px solid var(--color-border);
        }
        .shop-card-body { 
            padding: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .shop-info h3 { 
            margin: 0 0 4px 0;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--color-text-primary);
        }
        .shop-info p {
            margin: 0 0 12px 0;
            font-size: 0.9em;
            color: var(--color-text-secondary);
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            overflow: hidden;
        }
        .map-button {
            display: inline-block;
            background-color: var(--color-primary);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9em;
            text-align: center;
            align-self: flex-start;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .map-button:hover {
            background-color: var(--color-primary-dark);
        }
        #status-message { 
            text-align: center; 
            padding: 3em;
            color: var(--color-text-secondary);
            font-size: 1.1em;
        }
        .actions-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .delete-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            font-size: 1.2em;
            color: var(--color-text-secondary);
            transition: color 0.2s;
        }

        .delete-button:hover {
            color: #DC3545; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÑ‡∏õ‡∏ä‡∏µ‡πâ */
        }

    </style>
</head>
<body>
    <div class="header">
        <h1>‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h1>
        <div class="tabs">
            <button id="tab-watch_later" class="tab-button active" onclick="showList('watch_later')">‡∏î‡∏π‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</button>
            <button id="tab-favorites" class="tab-button" onclick="showList('favorites')">‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡∏î</button>
        </div>
    </div>
    
    <div class="content-area">
        <div id="status-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <div id="watch_later" class="shop-list active"></div>
        <div id="favorites" class="shop-list"></div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
    let liffProfile = null; // ‡πÄ‡∏Å‡πá‡∏ö profile ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥
    let loadedTabs = {};   // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤ Tab ‡πÑ‡∏´‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    async function main() {
        try {
            // 1. Initialize LIFF
            await liff.init({ liffId: "2007704697-mv4GBn6P" });

            if (!liff.isLoggedIn()) {
                document.getElementById('status-message').innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                return;
            }

            liffProfile = await liff.getProfile();

            // 2. ‡πÅ‡∏™‡∏î‡∏á Tab ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏î‡∏π‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)
            await showList('watch_later');
            
            // 3. ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
            document.querySelector('.content-area').addEventListener('click', handleDeleteClick);

        } catch (error) {
            console.error('An error occurred during initialization:', error);
            document.getElementById('status-message').innerText = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ';
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏±‡∏ö Tab
    window.showList = async function(type) {
        document.querySelectorAll('.shop-list').forEach(list => list.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

        document.getElementById(type).classList.add('active');
        document.getElementById(`tab-${type}`).classList.add('active');
        
        if (!loadedTabs[type]) {
            await loadShopData(type);
            loadedTabs[type] = true;
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Card
    async function loadShopData(type) {
        const statusMessage = document.getElementById('status-message');
        const listDiv = document.getElementById(type);
        
        statusMessage.style.display = 'block';
        statusMessage.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
        listDiv.innerHTML = '';

        try {
            const response = await fetch(`/get-saved-shops?userId=${liffProfile.userId}&type=${type}`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to fetch shops');
            }

            const shops = data.shops;

            if (shops.length === 0) {
                listDiv.innerHTML = `<p style="text-align: center; color: #888;">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>`;
            } else {
                shops.forEach(shopData => {
                    const card = document.createElement('div');
                    card.className = 'shop-card';
                    // --- VVVVVV ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç HTML ‡∏Ç‡∏≠‡∏á Card ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö VVVVVV ---
                    card.innerHTML = `
                        <img src="${shopData.imageUrl}" alt="${shopData.name}">
                        <div class="shop-card-body">
                            <div class="shop-info">
                                <h3>${shopData.name}</h3>
                                <p>${shopData.address || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'}</p>
                            </div>
                            <div class="actions-container">
                                <a href="https://www.google.com/maps/search/?api=1&query=Google&query_place_id=${shopData.id}" target="_blank" class="map-button">‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
                                <button class="delete-button" data-shop-id="${shopData.id}" data-type="${type}">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                    // --- ^^^^^^ ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ^^^^^^ ---
                    listDiv.appendChild(card);
                });
            }
            statusMessage.style.display = 'none';

        } catch (error) {
            console.error(`Error loading ${type} list:`, error);
            listDiv.innerHTML = `<p style="text-align: center; color: red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
            statusMessage.style.display = 'none';
        }
    }
    
    // --- VVVVVV ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏ö VVVVVV ---
    async function handleDeleteClick(event) {
        const deleteButton = event.target.closest('.delete-button');

        if (!deleteButton) {
            return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
        }

        const shopId = deleteButton.dataset.shopId;
        const type = deleteButton.dataset.type;

        // ‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö
        if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?')) {
            return;
        }
        
        try {
            // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server
            const response = await fetch('/delete-saved-shop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: liffProfile.userId,
                    shopId: shopId,
                    type: type
                })
            });

            const result = await response.json();

            if (result.success) {
                // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏•‡∏ö card ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                const cardToRemove = deleteButton.closest('.shop-card');
                cardToRemove.style.transition = 'opacity 0.3s ease';
                cardToRemove.style.opacity = '0';
                setTimeout(() => {
                    cardToRemove.remove();
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ list ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                    const listDiv = document.getElementById(type);
                    if (listDiv.children.length === 0) {
                         listDiv.innerHTML = `<p style="text-align: center; color: #888;">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>`;
                    }
                }, 300);
            } else {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ');
            }
        } catch (error) {
            console.error('Error deleting shop:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');
        }
    }
    // --- ^^^^^^ ‡∏à‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà ^^^^^^ ---

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    main();
</script>
</body>
</html>